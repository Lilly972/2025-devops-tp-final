name: üöÄ CI/CD Pipeline Christmas Gift List

# D√©clenche le workflow sur chaque push vers la branche 'main'
on:
  push:
    branches:
      - main

jobs:
  # ----------------------------------------------------
  # JOB 1: Continuous Integration (Tests & Qualit√©)
  # ----------------------------------------------------
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Go (Backend)
        uses: actions/setup-go@v5
        with:
          go-version: '1.23' # 
          cache-dependency-path: backend/go.sum # Correction pour le cache Go

      - name: üß™ Run Backend Tests & Quality Checks
        run: |
          cd backend
          go mod download
          go test ./... -v # Ex√©cute les tests unitaires Go
          go vet ./...      # V√©rifie la qualit√© du code Go

      - name: ‚öôÔ∏è Setup Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: 18 #
          cache-dependency-path: frontend/package-lock.json # Correction pour le cache Node.js

      - name: üß™ Run Frontend Tests & Quality Checks
        run: |
          cd frontend
          npm install
          npm run test         # Ex√©cute les tests Vitest
          npm run lint         # Ex√©cute ESLint
          npm run format:check # V√©rifie le format Prettier

  # ----------------------------------------------------
  # JOB 2: Build & Push Images to Docker Hub
  # ----------------------------------------------------
  publish-docker:
    needs: ci # D√©marre seulement si le job de CI a r√©ussi
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ${{ secrets.DOCKER_USERNAME }}/christmas-gift-list
      TAG: ${{ github.sha }}
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # Utilise le PAT Docker Hub

      - name: üõ†Ô∏è Build and push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REPO }}_backend:${{ env.TAG }} # Ex: user/christmas-gift-list_backend:sha

      - name: üõ†Ô∏è Build and push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REPO }}_frontend:${{ env.TAG }} # Ex: user/christmas-gift-list_frontend:sha

  # ----------------------------------------------------
  # JOB 3: Deploy Frontend (Documentation) & Trigger Backend Update
  # ----------------------------------------------------
  deploy:
    needs: publish-docker # D√©marre seulement si les images ont √©t√© pouss√©es
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      # -- DEPLOIEMENT NETLIFY (Documentation / Storybook) --
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üõ†Ô∏è Build Storybook/Documentation
        run: |
          cd frontend
          npm install
          npm run build-storybook # Construit la documentation Storybook

      - name: üöÄ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=frontend/storybook-static --prod # D√©ploie le dossier Storybook
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      # -- D√âCLENCHEMENT RENDER (Backend) --
      - name: üí• Trigger Render Deploy Hook
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  # ----------------------------------------------------
  # JOB 4: Create GitHub Release
  # ----------------------------------------------------
  create-release:
    needs: deploy # D√©marre seulement si le d√©ploiement a r√©ussi
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }} # Utilise le num√©ro d'ex√©cution comme tag
          name: Release v${{ github.run_number }}
          body: New features and fixes deployed via CI/CD pipeline.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Secret g√©r√© automatiquement