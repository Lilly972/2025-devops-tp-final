name: ğŸš€ CI/CD Pipeline Christmas Gift List

# DÃ©clenche le workflow sur chaque push vers la branche 'main'
on:
  push:
    branches:
      - main

jobs:
  # ----------------------------------------------------
  # JOB 1: Continuous Integration (Tests & QualitÃ©)
  # ----------------------------------------------------
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Go (Backend)
        uses: actions/setup-go@v5
        with:
          go-version: '1.23' # Version Go 
          cache-dependency-path: |
            backend/go.sum

      - name: ğŸ§ª Run Backend Tests & Quality Checks
        run: |
          cd backend
          go mod download
          go test ./... -v # ExÃ©cute les tests unitaires Go
          go vet ./...      # VÃ©rifie la qualitÃ© du code Go

      - name: âš™ï¸ Setup Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: 18 # Version Node.js requise par le TP

      - name: ğŸ§ª Run Frontend Tests & Quality Checks
        run: |
          cd frontend
          npm install
          npm run test         # ExÃ©cute les tests Vitest
          npm run lint         # ExÃ©cute ESLint
          npm run format:check # VÃ©rifie le format Prettier

  # ----------------------------------------------------
  # JOB 2: Build & Push Images to Docker Hub
  # ----------------------------------------------------
  publish-docker:
    needs: ci # DÃ©marre seulement si le job de CI a rÃ©ussi
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ${{ secrets.DOCKER_USERNAME }}/christmas-gift-list
      TAG: ${{ github.sha }}
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # Utilise le PAT Docker Hub

      - name: ğŸ› ï¸ Build and push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REPO }}_backend:${{ env.TAG }} # Ex: user/christmas-gift-list_backend:sha

      - name: ğŸ› ï¸ Build and push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REPO }}_frontend:${{ env.TAG }} # Ex: user/christmas-gift-list_frontend:sha

  # ----------------------------------------------------
  # JOB 3: Deploy Frontend (Documentation) & Trigger Backend Update
  # ----------------------------------------------------
  deploy:
    needs: publish-docker # DÃ©marre seulement si les images ont Ã©tÃ© poussÃ©es
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      # -- DEPLOIEMENT NETLIFY (Documentation / Storybook) --
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ› ï¸ Build Storybook/Documentation
        run: |
          cd frontend
          npm install
          npm run build-storybook # Construit la documentation Storybook

      - name: ğŸš€ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=frontend/storybook-static --prod # DÃ©ploie le dossier Storybook
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      # -- DÃ‰CLENCHEMENT RENDER (Backend) --
      - name: ğŸ’¥ Trigger Render Deploy Hook
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  # ----------------------------------------------------
  # JOB 4: Create GitHub Release
  # ----------------------------------------------------
  create-release:
    needs: deploy # DÃ©marre seulement si le dÃ©ploiement a rÃ©ussi
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }} # Utilise le numÃ©ro d'exÃ©cution comme tag
          name: Release v${{ github.run_number }}
          body: New features and fixes deployed via CI/CD pipeline.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Secret gÃ©rÃ© automatiquement